<html>

<head>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="score.css">
    <script src="timer.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    <style>
        body {
        background-color: white;
    }
    </style>


    <script>
        var pinTimer = null;
        var h1;
        var uiTimerVal = 0;

        function timer() {
            pinTimer.timer();
        }

        function toggleDiv(divName) {
            $("#" + divName).toggle();
        }
    </script>

</head>

<body>
    <div id="bountyBoard"></div>

    <div id="pinTimerBoard"></div>

    <div id="scoreboard"></div>

    <br />

    Bounty Bot (<a href="javascript:toggleDiv('addPlayers')">toggle</a>) <br />
    <div id="addPlayers" class="widget" style="display: none">
        <table>
            <tr>
                <td>
                    <p>
                        Initials: <input type="text" id="playerName" size="5" maxlength="5">
                        <button onclick="addPlayer('bounty')">Add Player</button>
                    </p>
                    <p>Bounty:<br />
                        <textarea rows="5" cols="50" id="bountyText"></textarea><br />
                        <button onclick="addBounty()">Add Bounty</button><br />
                        <input type="checkbox" id="hideBounty" onclick="doHideBounty()" /> - Hide Bounties
                    </p>
                </td>
                <td>
                    <div id="addScores">

                    </div>
                </td>
            </tr>
        </table>
    </div>


    pinTimer (<a href="javascript:toggleDiv('pinTimer')">toggle</a>) <br />
    <div id="pinTimer" class="widget">
        <table>
            <tr>
                <td>
                    <p>
                        Initials: <input type="text" id="pinTimerPlayerName" size="5" maxlength="5">
                        <button onclick="addPlayer('pinTimer')">Add Player</button>
                    </p>
                    <p>
                        Game: <input type="text" id="pinTimerGameName" /> <button onclick="setPinTimerGameName()">set</button>
                    </p>
                    <p>Objective:<br />

                        <textarea rows="5" cols="50" id="objectiveText"></textarea><br />
                        <button onclick="addObjective()">Add Objective</button>
                    </p>

                </td>
                <td>
                    <div id="objectiveUi"></div><br />
                    <button id="pinTimer-start" accesskey="/">Start (Alt+/)</button>
                    <button id="pinTimer-clear" accesskey="*">Clear (Alt+*)</button>
                    <button id="pinTimer-save" accesskey="-">Save</button>
                </td>
            </tr>
        </table>

    </div>
    </div>

    <div id="editPlayer">
        <p>Edit Player</p>
        <p>name: <input type="text" id="editName" /></p>
        <p>text: <input type="text" id="editText" /></p>
        <p><input type="checkbox" id="editDelete" name="editDelete"> Delete? </p>

        <p><button onclick="saveEdit()">save</button></p>
        <input type="hidden" name="editPlayerId" id="editPlayerId" />
    </div>

    <div id="editBounty">
        <p>Edit Bounty</p>
        <p>Bounty:<br />
            <textarea id="editBountyText"></textarea>
            <p><input type="checkbox" id="editBountyDelete" name="editBountyDelete"> Delete? </p>

            <p><button onclick="saveBounty()">save</button></p>
            <input type="hidden" name="editBountyId" id="editBountyId" />
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(function () {
            var socket = io();
            window['taco'] = socket;
            $('#start').click(function () {
                socket.emit('start', 'start');
            });

            socket.on('chat message', function (msg) {
                $('#messages').append($('<li>').text(msg));
            });

            socket.on('start', function (msg) {
                console.log('got start');
            });

           socket.on('uiTimerTime', function (msg) {
                console.log('got uiTimerVal: ' + msg + ", " + pinTimer.getRunTime());
                uiTimerVal = msg;
            });

            socket.on('startTimer', function (msg) {
                console.log('got startTimer');
                timer();
            });

            socket.on('clearTimer', function (msg) {
                console.log('got clearTimer');
            });

        });
    </script>

    <script>

        // Handle on child window
        var obsWindow = null;

        // global player array and Id counter
        var players = new Array();
        var playerId = 0;

        // bounty holder
        var bountyArray = new Array();
        var bountyId = 0;

        // holds objectives
        var objectiveArray = [];
        var objectiveId = 0
        var currentObjectiveId = null;

        // hold pinruns...
        var pinRunArray = [];

        var currentPlayerId = null;

        var pinTimerGame = "";

        var hideBountyBoard = false;

        function Person(name, theDesc) {
            this.name = name;
            this.score = 0;
            this.description = theDesc;
            this.playerId = playerId++;
            this.deleted = false;
            this.bounties = new Array();
        }

        function Bounty(desc) {
            this.description = desc;
            this.bountyId = bountyId++;
            this.deleted = false;
        }

        function Objective(name) {
            this.name = name;
            this.objectiveId = objectiveId++;
        }

        function PinRun(playerId, objectiveId, runTime) {
            this.playerId = playerId;
            this.objectiveId = objectiveId;
            this.runTime = runTime;
        }

        function getPlayerById(theId) {
            //console.log("getPlayerById : " + theId);
            if (players) {
                for (var i = 0; i < players.length; i++) {
                    if (players[i].playerId == parseInt(theId)) {
                        //console.log("returning player.....")
                        //console.log(players[i]);
                        return players[i];
                    }
                }
            }
        }

        function getObjectiveById(theId) {
            // console.log("getObjectiveById : " + theId);
            if (objectiveArray) {
                for (var i = 0; i < objectiveArray.length; i++) {
                    if (objectiveArray[i].objectiveId == parseInt(theId)) {
                        //console.log("returing objective...");
                        //console.log(objectiveArray[i]);
                        return objectiveArray[i];
                    }
                }
            }
        }

        function getBountyById(theId) {
            console.log("getBountyById : " + theId);
            if (bountyArray) {
                for (var i = 0; i < bountyArray.length; i++) {
                    if (bountyArray[i].bountyId == parseInt(theId)) {
                        //console.log("returning bounty.....")
                        //console.log(bountyArray[i]);
                        return bountyArray[i];
                    }
                }
            }
        }

        Person.prototype.addScore = function (addValue) {
            this.score += parseInt(addValue);
        }

        function addBounty() {
            var bountyName = $("#bountyText").val();
            console.log(bountyName);

            if (bountyName == null || bountyName.length == 0) {
                console.log("no bounty, not adding... ");
                return;
            }

            // Add bounty
            bountyArray.push(new Bounty($("#bountyText").val()));

            $("#bountyText").val("");

            repaint();
        }

        function addObjective() {
            var objectiveName = $("#objectiveText").val();
            console.log(objectiveName);

            if (objectiveName == null || objectiveName.length == 0) {
                console.log("no objectiveName, not adding... ");
                return;
            }


            // Add objective
            objectiveArray.push(new Objective(objectiveName));

            console.log(objectiveArray);

            $("#objectiveText").val("");

            repaint();
        }

        function addPlayer(widgetName) {
            var playerName = null;

            if (widgetName == "bounty") {
                playerName = $("#playerName").val();
            }
            else if (widgetName == "pinTimer") {
                playerName = $("#pinTimerPlayerName").val();
            }

            if (playerName == null || playerName.length == 0) {
                console.log("no value entered, not adding");
                return;
            }

            var newPlayer = new Person(playerName, "");
            players.unshift(newPlayer);

            $("#pinTimerPlayerName").val("");
            $("#playerName").val("");
            //$("#playerName").focus();

            repaint();
        }

        function givePoints() {
            for (var i = 0; i < players.length; i++) {
                var newScore = $("#score" + i).value;
                players[i].addScore(newScore);
            }

            repaint();
        }

        function doPoint(theObj) {

            console.log("doPoint for id: " + theId);

            if (theObj) {
                if (theObj.id.indexOf('plus') == 0) {
                    var theId = theObj.id.substring(4);
                    var p = getPlayerById(theId);
                    p.addScore(1);
                }

                if (theObj.id.indexOf('minus') == 0) {
                    var theId = theObj.id.substring(5);
                    var p = getPlayerById(theId);
                    p.addScore(-1);
                }
            }

            repaint();
        }

        function editPlayer(theObj) {

            if (theObj) {

                console.log(theObj.id);
                var parsedId = theObj.id.substring(9);

                console.log(getPlayerById(parsedId));
                var p = getPlayerById(parsedId);
                $("#editName").val(p.name);
                $("#editText").val(p.description);
                $('input[name=editPlayerId]').val(p.playerId);
                $("#editPlayer").dialog("open");
            }
        }

        function editBounty(theObj) {
            if (theObj) {
                console.log("in editBounty: " + theObj.id);
                var parsedId = theObj.id.substring(9);

                console.log(getBountyById(parsedId));
                var b = getBountyById(parsedId);
                $("#editBountyText").val(b.description);
                $('input[name=editBountyId]').val(b.bountyId);
                $("#editBounty").dialog("open");
            }
        }

        function saveBounty() {
            var theId = $("#editBountyId").val();
            console.log("saveBounty: theId: " + theId);

            var b = getBountyById(theId);

            if ($("#editBountyDelete").prop('checked')) {
                console.log("delete this bounty: " + theId);
                b.deleted = true;
            }
            else {
                b.description = $("#editBountyText").val();
            }

            // clear the form
            $("#editBountyText").val("");
            $("#editBountyDelete").prop('checked', false);

            // close dialog
            $("#editBounty").dialog("close");

            // repaint
            repaint();
        }

        function saveEdit() {
            var theId = $("#editPlayerId").val();
            console.log("saveEdit: theId: " + theId);

            var p = getPlayerById(theId);

            if ($("#editDelete").prop('checked')) {
                console.log("delete this guy: " + theId);
                p.deleted = true;

            }
            else {
                // it's updating the current record
                p.name = $("#editName").val();
                p.description = $("#editText").val();
            }

            // clear the form
            $("#editName").val("");
            $("#editText").val("");
            $("#editDelete").prop('checked', false);

            // close dialog
            $("#editPlayer").dialog("close");

            repaint();
        }

        function repaint() {
            // repaint
            drawScoreboard(players);
            drawScores(players);

            console.log(window['taco']);            

            // repaint OBS window
            refreshObsWindow();
        }

        function drawScores(thePlayers) {
            var theString = "<div>Players</div>";
            for (var i = 0; i < thePlayers.length; i++) {
                if (!thePlayers[i].deleted) {
                    theString += "<div>" + thePlayers[i].name + " <button onclick='doPoint(this)' id='plus" + thePlayers[i].playerId + "'>+</button><button  onclick='doPoint(this)'id='minus" + thePlayers[i].playerId + "'>-</button>";
                    theString += "<button onclick='editPlayer(this)' id='playerId-" + thePlayers[i].playerId + "'>edit</button>";

                    theString += drawBountyUi(thePlayers[i]);
                }
            }

            theString += drawBountyEdit();

            $("#addScores").html(theString);

            console.log(drawObjectivesEdit());

            $("#objectiveUi").html(drawObjectivesEdit());
        }

        function drawObjectivesEdit() {

            var theString = "<p>Current Game: " + pinTimerGame + "</p>";
            theString += "<div>Current objectives</div>";

            $.each(objectiveArray, function (i) {
                theString += "<input id='pinTrackerObjectiveId-" + this.objectiveId + "' type='radio' name='currentObjective' value='" + this.objectiveId + "' onclick='setCurrentObjective(" + this.objectiveId + ")'>" + this.name + "<br />";
            });

            theString += "<div>Current players</div>";

            $.each(players, function (i) {
                theString += "<input id='pinTrackerCurrentPlayerId-" + players.name + " 'type='radio' name='currentPlayer' value='" + this.name + "' onclick='setCurrentPlayer(\"" + this.playerId + "\")'>" + this.name + "<br />";
            });


            return theString;
        }

        function setPinTimerGameName() {
            pinTimerGame = $("#pinTimerGameName").val();

            repaint();
        }

        function setCurrentPlayer(playerId) {
            console.log("in setCurrentPlayer: " + playerId);
            currentPlayerId = playerId;

            // $("#pinTrackerObjectiveId-" + playerId).attr("checked", "checked");

            drawScoreboard(players);
        }

        function setCurrentObjective(objectiveId) {
            console.log("in setCurrentObjective: " + objectiveId);
            currentObjectiveId = objectiveId;

            // $("#pinTrackerObjectiveId-" + objectiveId).attr("checked", "checked");

            drawScoreboard(players);
        }

        function applyBounty(pId, bId) {
            console.log("in applyBounty, playerId: " + pId + ", bountyId: " + bId);
            var p = getPlayerById(pId);
            console.log(p);

            var found = false;

            // if it exists remove it
            for (var i = 0; i < p.bounties.length; i++) {
                if (p.bounties[i] == bId) {
                    p.bounties.splice(i, 1);
                    found = true;
                    p.addScore(-1);
                }
            }

            // else we add it in
            if (!found) {
                p.bounties.push(bId);
                p.addScore(1);
            }

            repaint();
        }

        function drawBountyUi(thePlayer) {
            var theString = "";
            if (thePlayer && bountyArray) {
                for (var i = 0; i < bountyArray.length; i++) {
                    if (!bountyArray[i].deleted) {
                        if (hasBounty(thePlayer, bountyArray[i].bountyId)) {
                            theString += '<input type="checkbox" onclick="applyBounty(' + thePlayer.playerId + ', ' + bountyArray[i].bountyId + ')" checked="checked">';
                        }
                        else {
                            theString += '<input type="checkbox" onclick="applyBounty(' + thePlayer.playerId + ', ' + bountyArray[i].bountyId + ')">';
                        }
                    }
                }
            }

            return theString;
        }

        function drawScoreboard(thePlayers) {
            var theString = "";
            /* console.log("in drawScoreboard");
            var theString = "<ul class='scoreboard'>";
            for (var i = 0; i < thePlayers.length; i++) {
                if (!thePlayers[i].deleted) {
                    theString += "<li class='simpleScore'><div class='simpleName'>" + thePlayers[i].name + "</div>" +
                        "<div class='simplePoints'>" + thePlayers[i].score + "</div><div class='simpleDescription'></div>";

                    if (!hideBountyBoard) {
                        theString += drawBountyScore(thePlayers[i]);
                    }

                    theString += "</li>";
                }
            }

            theString += '</ul>';

            $("#scoreboard").html(theString);

            if (!hideBountyBoard) {
                theString = drawBountyBoard(bountyArray) + theString;
            }
            else {
                $("#bountyBoard").html("");
            } */

            theString += drawPinTimer();

            window['taco'].emit('start', theString);

            return theString;
        }

        function drawPinTimer() {
            console.log("in drawPinTimer");

            var theString = "<div class='bountyBoard'><div class='bountyTitle'>Speed Runs</div>";

            //theString += "<p>Game: " + pinTimerGame + "</p>";

            console.log("currentObjectiveId: " + currentObjectiveId);

            if (currentObjectiveId != null) {
                var theObj = getObjectiveById(currentObjectiveId);

                console.log(getObjectiveById(currentObjectiveId).name);

                if (theObj) {
                    theString += "<p class='bountyDescription'>Current objective: " + getObjectiveById(currentObjectiveId).name + "</p>";
                }
            }

            if (currentPlayerId != null) {
                var theObj = getPlayerById(currentPlayerId);

                console.log(getPlayerById(currentPlayerId).name);

                if (theObj) {
                    theString += "<p class='bountyDescription'>Current Player: " + getPlayerById(currentPlayerId).name + "</p>";
                }
            }

            theString += "<h1 class='speedrunTimer'>" + timeFormatter(0) + "</h1>";

            var bestRun = getBestRun(currentObjectiveId);
            var bestRunString = "---"
            if (bestRun != undefined) {
                bestRunString = timeFormatter(bestRun.runTime);
                bestRunString += " (" + getPlayerById(bestRun.playerId).name + ")";
            }

            theString += "<p class='bountyDescription'>time to beat: " + bestRunString + "</p>";
            theString += "<p class='bountyDescription'>personal best: ";
            var personalBestString = "---";

            var personalBest = getBestRunForPlayer(currentPlayerId, currentObjectiveId);

            if (personalBest != undefined) {
                personalBestString = timeFormatter(personalBest.runTime);
            }

            theString += personalBestString + "</p>";

            theString += "<p class='bountyTitle'>Previous Runs</p>";

            var previousRuns = getPinRuns(currentPlayerId, currentObjectiveId);
            var previousRunsString = "<p class='bountyDescription'>";

            if (previousRuns != undefined && previousRuns.length > 0) {
                for (var i = 0; i < previousRuns.length; i++) {
                    previousRunsString += "<br />" + (i + 1) + ". " + timeFormatter(previousRuns[i].runTime);
                }
            }
            else {
                previousRunsString += "---";
            }

            theString += previousRunsString;
            theString += "</p>";

            $("#pinTimerBoard").html(theString);

            theString += "</ul>";

            h1 = document.getElementsByTagName('h1')[0];

            return theString;

        }

        function hasBounty(thePlayer, bountyId) {
            if (thePlayer && thePlayer.bounties && thePlayer.bounties.length > 0) {
                for (var i = 0; i < thePlayer.bounties.length; i++) {
                    console.log("hasBounty: " + thePlayer.bounties[i] + ", " + bountyId);
                    if (thePlayer.bounties[i] == bountyId) {
                        return true;
                    }
                }
            }

            return false;
        }

        function getPinRuns(playerId, objectiveId) {
            var runs = [];

            // find all the runs for the given objective and player...
            for (var i = 0; i < pinRunArray.length; i++) {
                if (pinRunArray[i].playerId == playerId && pinRunArray[i].objectiveId == objectiveId) {
                    runs.unshift(pinRunArray[i]);
                }
            }

            return runs;
        }

        function getBestRunForPlayer(playerId, objectiveId) {
            var playerRuns = getPinRuns(playerId, objectiveId);

            var bestTime = 0;
            var bestRun = null;

            // find the quickest run in the mix...
            for (var i = 0; i < playerRuns.length; i++) {
                if (bestTime == 0) {
                    bestRun = playerRuns[i];
                    bestTime = playerRuns[i].runTime;
                }
                else if (playerRuns[i].runTime < bestTime) {
                    bestRun = playerRuns[i];
                    bestTime = playerRuns[i].runTime;
                }
            }

            return bestRun;
        }

        function getBestRun(objectiveId) {
            var objectiveRuns = [];

            // find all the runs for the given objectiveId
            for (var i = 0; i < pinRunArray.length; i++) {
                if (pinRunArray[i].objectiveId == objectiveId) {
                    objectiveRuns.push(pinRunArray[i]);
                }
            }

            var bestTime = 0;
            var bestRun = null;

            // find the quickest run in the mix...
            for (var i = 0; i < objectiveRuns.length; i++) {
                if (bestTime == 0) {
                    bestRun = objectiveRuns[i];
                    bestTime = objectiveRuns[i].runTime;
                }
                else if (objectiveRuns[i].runTime < bestTime) {
                    bestRun = objectiveRuns[i];
                    bestTime = objectiveRuns[i].runTime;
                }
            }

            return bestRun;
        }

        function drawBountyScore(thePlayer) {
            console.log("in drawBountyScore...");

            var theString = "<div class='bountyScoreList'>";
            for (var i = 0; i < bountyArray.length; i++) {
                if (!bountyArray[i].deleted) {

                    if (hasBounty(thePlayer, bountyArray[i].bountyId)) {
                        theString += '<label class="container"><input type="checkbox" checked="checked"><span class="checkmark"></span></label>';
                        // theString += "<label for='box-" + thePlayer.playerId + "-" + bountyArray[i].bountyId + "'></label><input type='checkbox'  class='sexyBox' checked='true' id='box-" + thePlayer.playerId + "-" + bountyArray[i].bountyId + "' />";
                    }
                    else {
                        theString += '<label class="container"><input type="checkbox"><span class="checkmark"></span></label>';
                        //theString += "<label for='box-" + thePlayer.playerId + "-" + bountyArray[i].bountyId + "'> </label><input type='checkbox'  class='sexyBox' id='box-" + thePlayer.playerId + "-" + bountyArray[i].bountyId + "'/>";
                    }
                }
            }

            theString += "</div>";

            return theString;
        }

        function drawBountyBoard(theBountyArray) {
            console.log("in drawBountyBoard");

            var theString = "";

            theString += "<div class='bountyBoard'><div class='bountyTitle'>Bounty</div>";

            theString += "<div class='bountyList'>";
            for (var i = 0; i < bountyArray.length; i++) {
                if (!bountyArray[i].deleted) {
                    theString += "<p class='bountyDescription'>" + bountyArray[i].description + "</p>";
                }
            }

            theString += '</div>';

            theString += "</div>";

            $("#bountyBoard").html(theString);

            return theString;
        }

        function drawBountyEdit() {
            console.log("in drawBountyEdit");
            var theString = "<div>Bounties</div>";
            for (var i = 0; i < bountyArray.length; i++) {
                if (!bountyArray[i].deleted) {
                    theString += "<div>" + bountyArray[i].description + "<button onclick='editBounty(this)' id='bountyId-" + bountyArray[i].bountyId + "'>edit</button></div>";
                }
            }

            return theString;

        }

        function openObsWindow() {
            obsWindow = window.open("obsScore.html");
        }

        function refreshObsWindow() {
            if (obsWindow) {
                obsWindow.location.reload();
            }
        }

        function doHideBounty() {
            if ($("#hideBounty").prop('checked')) {
                hideBountyBoard = true;
            }
            else {
                hideBountyBoard = false;
            }

            console.log("after do hide" + hideBountyBoard);

            repaint();
        }


        $(
            function () {

                pinTimer = new PinTimer();
                //h1.textContent = timeFormatter(0);
                var started = false;

                $("#editPlayer").dialog({
                    autoOpen: false
                });

                $("#editBounty").dialog({
                    autoOpen: false
                })

                $("#pinTimer-start").on('click', function () {
                    if (!started) {
                        console.log("starting timer...");
                        $("#pinTimer-start").html("Stop (Alt+/)");
                        $("#pinTimer-clear").attr("disabled", true);
                        $("#pinTimer-save").attr("disabled", true);
                        started = true;
                    }
                    else {
                        console.log("stoping timer...");
                        $("#pinTimer-start").html("Start (Alt+/)");
                        $("#pinTimer-clear").attr("disabled", false);
                        $("#pinTimer-save").attr("disabled", false);
                        started = false;
                    }


                    window['taco'].emit("startTimer", "startTimer");
                });

                $("#pinTimer-save").on('click', function () {
                    console.log("saving run...");
                    var pinRun = new PinRun(parseInt(currentPlayerId), currentObjectiveId, pinTimer.getRunTime());
                    pinRunArray.push(pinRun);

                    var someRuns = getPinRuns(currentPlayerId, currentObjectiveId);

                    console.log(pinRun);
                    console.log(someRuns);
                    console.log(getBestRun(currentObjectiveId));

                    drawScoreboard(players);
                });

                $("#pinTimer-clear").on('click', function () {
                    console.log("clearing!!!");
                    h1.textContent = timeFormatter(0);
                    pinTimer.clear();
                    window['taco'].emit("clearTimer", "clearTimer");
                });

            }

        );



    </script>
</body>

</html>